# 車種登録UI/UX仕様書

## 概要
Smart Garageにおける車両登録のUI/UXフローと仕様を定義します。

## 現在の実装状況

### 登録方法
現在、車両の登録には以下の2つの方法が実装されています：

#### 1. ステップ型ウィザード（TypeaheadCarSelector）
車両登録のメインフロー。4ステップのウィザード形式で情報を入力します。

**ファイル**: `src/components/TypeaheadCarSelector.tsx`

#### 2. シンプルモーダル（AddCarModal）
簡易的な車両情報入力モーダル。直接入力で登録可能。

**ファイル**: `src/app/page.tsx` (AddCarModal)

---

## TypeaheadCarSelector（ステップ型ウィザード）

### 表示位置
- 車両管理画面（`currentPage === 'car-management'`）の「車種から選択」ボタンから起動
- モーダル表示（全画面オーバーレイ）

### ステップ構成

#### Step 1: メーカー選択
- **タイトル**: "メーカーを選択"
- **説明**: "メーカーを一覧から選択してください"
- **表示内容**:
  - 車種データベース（`src/lib/carDatabase.ts`）からメーカー一覧を表示
  - 国旗アイコン付きメーカー名
    - 🇯🇵 日本メーカー
    - 🇩🇪 ドイツメーカー
    - 🇺🇸 アメリカメーカー
  - 選択中の項目は青色背景 + チェックマーク表示
- **選択可能項目数**: 制限なし
- **自由度**: 候補にない場合の自由入力ボタンあり
- **次への遷移**: メーカー選択 or 自由入力で次へ

#### Step 2: 車種選択
- **タイトル**: "車種を選択"
- **説明**: "車種を一覧から選択してください"
- **前提条件**: メーカーが選択されている
- **表示内容**:
  - 選択されたメーカーの車種一覧を表示
  - 各車種の表示項目:
    - 車種名（太字）
    - 型式（あれば）
    - 排気量（あれば）
    - 世代（あれば）
  - 選択中の項目は青色背景 + チェックマーク表示
- **自由度**: 候補にない場合の自由入力ボタンあり
- **次への遷移**: 車種選択 or 自由入力で次へ

#### Step 3: 年式選択
- **タイトル**: "年式を選択"
- **説明**: "年式を選択してください"
- **表示内容**:
  - グリッド表示（4列）
  - 1990年から現在年まで
  - 選択中の年式は青色背景
- **必須**: Yes
- **自由度**: 選択のみ（自由入力なし）

#### Step 4: 車検満了日入力
- **タイトル**: "車検満了日を入力"
- **説明**: "車検満了日を入力してください（YYYY-MM-DD形式）"
- **入力形式**: 日付選択（date input）
- **必須**: Yes
- **ヒント**: "💡 ICカードから自動取得も可能です（今後実装予定）"

### 共通UI要素

#### 進捗インジケーター
- ヘッダー下に表示
- 4つのステップを数字とドットで表示
- 現在のステップ: 青色
- 完了したステップ: 緑色
- 未完了ステップ: グレー
- ステップ間の線も完了状況に応じて色分け

#### 選択内容の確認
- 各ステップで入力された内容を青色背景で表示
- 表示項目:
  - メーカー名
  - 車種名
  - 年式
  - 車検満了日

#### ナビゲーション
- **戻るボタン**: 最初のステップ以外で表示
- **次へ/完了ボタン**:
  - 入力内容が不正な場合、グレーアウト・クリック不可
  - 最終ステップでは「完了」、それ以外は「次へ」と表示

### データフロー

```
TypeaheadCarSelector選択完了
  ↓
page.tsx の pendingCarData に保存
  ↓
プレビュー画面表示
  ↓
ユーザー確認
  ↓
handleCarAdd() 実行
  ↓
addCar() でFirebaseに保存
```

### 選択されたデータの処理

```typescript
const carData: CarInput = {
  name: `${manufacturer.name} ${model.name}`,
  modelCode: model.modelCode,
  year: selectedYear,
  odoKm: 0, // 初期値
  inspectionExpiry: inspectionExpiry,
  imagePath: model.defaultImagePath || '/car.jpg'
};
```

---

## AddCarModal（シンプルモーダル）

### 表示位置
- ダッシュボードまたは車両管理画面の「車を追加」ボタンから起動
- モーダル表示（全画面オーバーレイ）

### 入力項目（順序通り）

1. **車名**（必須）
   - プレースホルダー: "車名（例：シビック Type R）"
   - 車種選択ボタンあり（緑色ボタン）

2. **車種選択ボタン**
   - クリックでCarModelSelectorを表示
   - 選択後、車名と型式が自動入力される

3. **型式**（任意）
   - プレースホルダー: "型式（例：FL5）"
   - 車種選択で自動入力されるが手動編集可

4. **車種選択確認表示**
   - 車種を選択した場合に表示
   - 緑色背景のカード
   - 表示内容:
     - メーカー名 + 車種名
     - 型式・排気量・世代

5. **年式**（任意）
   - プレースホルダー: "年式（例：2023）"
   - 数値入力

6. **走行距離**（任意）
   - プレースホルダー: "走行距離 km"
   - 数値入力

7. **車両画像**
   - 画像選択ボタン
   - 選択後のプレビュー表示
   - 圧縮情報の表示（自動圧縮）
   - アップロード進捗バー
   - 画像削除ボタン

8. **車検期限**（任意）
   - 日付選択（date input）

9. **初度登録年月**（任意）
   - 月選択（month input）
   - プレースホルダー: "例: 2020-03"

10. **平均月間走行距離**（任意）
    - セレクトボックス
    - 選択肢:
      - 300km/月（低使用）
      - 500km/月（普通）
      - 800km/月（高使用）
      - 1000km/月（超高使用）

### 画像処理

#### アップロード前
- **ファイル選択**: 画像ファイル選択ダイアログ
- **バリデーション**:
  - 画像ファイルのみ許可
  - 最大50MB
- **自動圧縮**:
  - 最大サイズ: 1200x1200px
  - 品質: 80%
  - 目標サイズ: 500KB以下
- **圧縮情報表示**:
  - 元のサイズ
  - 圧縮後のサイズ
  - 圧縮率

#### アップロード中
- 進捗バー表示
- 進捗率の表示
- オーバーレイで他の操作をロック

#### アップロード完了
- 完了メッセージ表示（0.5秒間）

### ボタン

- **キャンセル**: モーダルを閉じる
- **追加**: 車両を保存（アップロード中は無効化）

---

## 共通機能

### 車種データベース
**ファイル**: `src/lib/carDatabase.ts`

#### 構造
```typescript
interface CarManufacturer {
  id: string;
  name: string;
  country: 'japan' | 'germany' | 'usa';
  models: CarModel[];
}

interface CarModel {
  id: string;
  name: string;
  modelCode?: string;
  displacement?: number;
  generation?: string;
  defaultImagePath?: string;
}
```

### 車両データ構造
**ファイル**: `src/lib/cars.ts`

```typescript
interface Car {
  id?: string;
  name: string;
  modelCode?: string;
  year?: number;
  odoKm?: number;
  imagePath?: string;
  inspectionExpiry?: string;
  firstRegYm?: string;
  avgKmPerMonth?: number;
  engineCode?: string;
  oilSpec?: {
    viscosity: string;
    api: string;
    volumeL: number;
  };
  createdAt?: Date;
  updatedAt?: Date;
}
```

---

## UI/UX特徴

### TypeaheadCarSelectorの特徴
1. **段階的な情報入力**: 4ステップで分かれており、ユーザーの負担を軽減
2. **視覚的な進捗表示**: 現在位置が明確
3. **柔軟性**: 候補にない車種も自由入力可能
4. **確認表示**: 入力内容を常に表示して確認可能
5. **直感的なナビゲーション**: 戻る/次への移動がスムーズ

### AddCarModalの特徴
1. **シンプルさ**: 1画面で全情報を入力
2. **高速入力**: 必須項目のみで登録可能
3. **画像処理**: 自動圧縮とアップロード進捗表示
4. **車種選択補助**: 車種データベースからの選択で誤入力を防止

---

## 改善提案

### 発見された課題
1. **2つの登録方法の使い分けが不明確**
   - TypeaheadCarSelector と AddCarModal の用途の違いが分かりにくい

2. **TypeaheadCarSelector の使用箇所が限定的**
   - 車両管理画面からのみ起動可能
   - ダッシュボードには統合されていない

3. **自由入力の扱いが曖昧**
   - 自由入力で登録した場合の名前生成ロジックが不明確

4. **登録時の価値提示が不足**
   - 登録後何ができるかが不明確
   - メンテナンス計画の自動生成機能が隠れている

5. **バリデーション体験が悪い**
   - グレーアウトのみで理由が分からない
   - undefined の扱いで Firestore エラー発生

---

## 改善プラン（優先順位順）

### 🔥 今すぐ効く改善（小コスト）

#### 1. 入口を一本化

**現状の問題**
- 「車を追加」と「車種から選択」の2つのボタン
- 用途が分かりにくい

**改善案**
「車を追加」ボタンをクリック → モーダルで2択

```
┌─────────────────────────┐
│ 車を追加                 │
├─────────────────────────┤
│ [ かんたん追加 ]       │
│  最小2項目で登録        │
│  （車種＋年式）         │
├─────────────────────────┤
│ [ くわしく追加 ]       │
│  ウィザードで入力       │
└─────────────────────────┘
```

- **かんたん追加**: 最小限の情報で登録 → あとで追記できる
- **くわしく追加**: ウィザード（現行のTypeaheadCarSelector）

#### 2. ステップ名を分かりやすく

**変更前 → 変更後**
```
メーカー選択 → 車をえらぶ
車種選択     → （統合、検索で解決）
年式選択     → 年式
車検入力     → （必須解除）
            → 使い方
            → 確認して登録
```

**新ステップ構成**
1. **車をえらぶ** - 検索ボックスで検索
2. **年式** - グリッドから選択
3. **使い方** - 平均月間走行距離のみ（4択）
4. **確認して登録** - プレビュー + 自動生成される予定

**必須/任意の見直し**
```
必須：車種（or 車名）、年式
任意：車検満了日、平均月間走行、走行距離、画像、初度登録、型式
```

車検満了日は Step4 の確認画面に移動（任意項目として）

#### 3. 「その場で価値」の提示

**確認画面に表示**
```
┌─────────────────────────┐
│ 登録すると次のやることを │
│ 作成します              │
│                         │
│ ✅ オイル交換           │
│    5,000km / 6か月ごと │
│                         │
│ ✅ タイヤ交換           │
│    10,000km ごと        │
│                         │
│ ✅ ブレーキフルード     │
│    2年ごと              │
└─────────────────────────┘
```

**登録完了トースト**
```
✅ インプレッサ WRX を追加しました
   やること 3件を準備しました
```

#### 4. バリデーションのUX化

**現状の問題**
- グレーアウトだけで理由が分からない

**改善案**
```typescript
// インライン理由を表示
<Input 
  value={year}
  error="年式は1990〜今年の範囲で入力してください"
/>
```

**undefined → null の正規化**
```typescript
const clean = <T extends object>(o: T) =>
  JSON.parse(JSON.stringify(o, (_, v) => v === undefined ? null : v));

addCar(clean(carData)); // Firestore エラーを防止
```

#### 5. デフォルト画像の質アップ

**現状**: `/car.jpg` のみ

**改善案**
- manufacturer + model の組み合わせで適切な画像を割り当て
- SVG シルエット or 色違い写真
- 画像未選択でも「映える」見た目

#### 6. 途中保存（ドラフト）

**実装**
- ウィザード離脱時に `users/{uid}/drafts/cars/{draftId}` に保存
- 再開時にモーダルで「続きから始めますか？」
- 30日で自動削除

---

### 💰 中コストだが体験が跳ねる改善

#### 7. 検索を1画面に統合

**現状**: メーカー → 車種の2段階選択

**改善案**: 統合検索ボックス
```
プレースホルダ: 「メーカー・車名・型式で検索（例：ホンダ FL5）」

入力: "ho"
↓
候補:
🇯🇵 ホンダ
  → シビック
  → シビック Type R (FL5)
  → CR-V
  → ...

入力: "fl5"
↓
候補:
🇯🇵 ホンダ シビック Type R (FL5)
```

- メーカー/車種/型式を横断検索
- 選択すると残りは自動フィル

#### 8. 重複検知

```typescript
// 同じ name + year（±1年）を検知
const existing = cars.find(c => 
  c.name === name && 
  Math.abs((c.year || 0) - year) <= 1
);

if (existing) {
  // モーダル表示
  "同名の車両が見つかりました"
  [同名に切替] [新規として登録]
}
```

#### 9. 逆算入力

年式を入力 → 初度登録年月を自動推定（編集可）

#### 10. 「あとでやる」を常設

車検満了日・画像・平均走行の右に「あとで」チェックボックス
- チェックすると未入力の罪悪感を削減

#### 11. モバイル最適化

- `inputmode="numeric"` で数値キーボード
- 次へボタンをキーボード上に常駐
- タップ領域 44px 確保
- `accept="image/*;capture=camera"` でカメラ優先

---

### 📊 計測項目

**イベント**
- `car_add_start` - 登録開始
- `car_add_complete` - 登録完了
- `car_add_drop_step1` - Step1 で離脱
- `car_add_drop_step2` - Step2 で離脱
- etc.

**KPI**
- 入力時間（開始→完了）中央値
- 画像添付率
- プリセット編集率
- 登録直後のやること完了率（D1）

---

### 🔧 実装メモ

#### 新コンポーネント

```tsx
<CarSearchCombobox /> 
  // Step1: メーカー/車種/型式/年式の統合検索

<UsageStep /> 
  // avgKmPerMonth の4択

<CarReviewCard /> 
  // 確認用カード + 生成予定のやること一覧
```

#### プリセット生成

```typescript
// 登録成功時にまとめて書き込み
const plans = [
  { type: 'oil', interval: { km: 5000, days: 180 } },
  { type: 'tire', interval: { km: 10000 } },
  { type: 'brakeFluid', interval: { days: 730 } },
];
```

#### 保存前正規化

```typescript
const clean = <T extends object>(o: T) =>
  JSON.parse(JSON.stringify(o, (_, v) => v === undefined ? null : v));

addCar(clean(carData));
```

---

### 🎨 マイクロコピー（そのまま使える）

- 検索プレースホルダ: 「メーカー・車名・型式で検索（例：ホンダ FL5）」
- 年式ヒント: 「だいたいでOK。後から変更できます。」
- 使い方ヒント: 「走行ペースに合わせて"次にやること"を自動調整します。」
- 確認画面: 「登録すると、以下のやることを作成します（いつでも編集可）」
- 完了トースト: 「インプレッサ WRX を追加しました。やること 3件を準備しました。」

---

### ♿ アクセシビリティ

- フォーカスリングの視認性（`focus-visible:ring-2`）
- ライブリージョンで進捗アナウンス
- スクリーンリーダー向け進捗説明（「ステップ2/4：年式」）

---

## 推奨実装順序

1. **Phase 1（今すぐ）**: 入口一本化、ステップ名変更、必須/任意の見直し
2. **Phase 2（1週間以内）**: 価値提示、バリデーション改善、undefined の正規化
3. **Phase 3（2週間以内）**: 統合検索、重複検知、ドラフト機能
4. **Phase 4（1ヶ月以内）**: モバイル最適化、計測、アクセシビリティ

---

## 技術的詳細

### 画像処理
- **圧縮ライブラリ**: `src/lib/imageCompression.ts`
- **ストレージ**: Firebase Storage
- **進捗監視**: `uploadBytesResumable`
- **タイムアウト**: 30秒

### データ永続化
- **DB**: Firebase Firestore
- **コレクション**: `users/{userId}/cars/`
- **リアルタイム同期**: `onSnapshot`

### 状態管理
- **グローバル状態**: page.tsx の useState
- **モーダル状態**: 各コンポーネント内で管理
- **ペンディングデータ**: pendingCarData state

---

*最終更新: 2025年1月*
