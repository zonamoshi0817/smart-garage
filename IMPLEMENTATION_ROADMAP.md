# Smart Garage å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

## ãƒã‚¤ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆFBå¯¾å¿œï¼ˆå„ªå…ˆåº¦: é«˜ â†’ ä¸­ï¼‰

### ğŸ”´ Phase 1: åŸºç›¤ã®å …ç‰¢åŒ–ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

#### 1. ãƒ‡ãƒ¼ã‚¿å‹ã®çµ±ä¸€ âš¡ **ä»Šã™ãå¯¾å¿œ**
**å•é¡Œ**: `inspectionExpiry`ãŒstring/Dateæ··åœ¨  
**è§£æ±ºç­–**: Firestore Timestampã«çµ±ä¸€

```typescript
// ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- string â†’ Timestampå¤‰æ›
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- UIå±¤ã§dayjsã«å¤‰æ›

// ãƒ«ãƒ¼ãƒ«
- ã‚µãƒ¼ãƒãƒ¼å¢ƒç•Œ: Timestamp
- UIå±¤: dayjså¤‰æ›
- å°†æ¥ã®ã‚¯ã‚¨ãƒªå¯¾å¿œ: ã€ŒæœŸé™ãŒè¿‘ã„é †ã€
```

**å½±éŸ¿ç¯„å›²**:
- `src/lib/cars.ts`
- `src/types/index.ts`
- å…¨è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ

**å®Ÿè£…æ™‚é–“**: 1-2æ™‚é–“

---

#### 2. æ‰€æœ‰æ¨©ãƒ»ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ã‚·ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  ğŸ”
**ç›®çš„**: å…±æœ‰URLã€å®¶æ—å…±æœ‰ã€B2Bæ¥ç¶šã®åœŸå°

```typescript
// å…¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
interface BaseEntity {
  ownerUid: string;      // æ‰€æœ‰è€…UID
  createdBy: string;     // ä½œæˆè€…UID
  updatedBy: string;     // æ›´æ–°è€…UID
  deletedAt?: Timestamp; // è«–ç†å‰Šé™¤
}
```

**å¯¾è±¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**:
- `cars`
- `maintenance`
- `fuelLogs`
- `customizations`
- `insurancePolicies`

**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

---

#### 3. ç›£æŸ»è¨¼è·¡ï¼ˆAudit Logï¼‰ ğŸ“œ
**ç›®çš„**: å±¥æ­´=è³‡ç”£ã€è¨¼æ˜æ€§ã€ä¿¡é ¼æ€§

```typescript
// audits ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
interface AuditLog {
  entityType: 'car' | 'maintenance' | 'fuelLog' | 'customization';
  entityId: string;
  action: 'create' | 'update' | 'delete';
  diff?: Record<string, any>;  // å¤‰æ›´å·®åˆ†
  actorUid: string;             // æ“ä½œè€…
  at: Timestamp;                // æ“ä½œæ—¥æ™‚
  metadata?: {
    ip?: string;
    userAgent?: string;
  };
}
```

**æ´»ç”¨ã‚·ãƒ¼ãƒ³**:
- PDFå±¥æ­´æ›¸ã«ã€Œæœ€çµ‚æ›´æ–°: æ—¥æ™‚/ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€
- ä¸æ­£æ“ä½œã®è¿½è·¡
- å…±æœ‰URLæ™‚ã®ä¿¡é ¼æ€§è¨¼æ˜

**å®Ÿè£…æ™‚é–“**: 3-4æ™‚é–“

---

### ğŸŸ¡ Phase 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

#### 4. OCR Web WorkeråŒ– ğŸš€
**å•é¡Œ**: Tesseract.jsã§UIãŒå›ºã¾ã‚‹

```typescript
// å¯¾å¿œç­–
1. Web WorkeråŒ–
2. traineddataã‚’IndexedDBã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
3. 2æ®µéšå‡¦ç†:
   - ä½è§£åƒåº¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸå€™è£œæŠ½å‡º
   - åŸå¯¸ã‚¹ãƒŠãƒƒãƒ— â†’ é«˜ç²¾åº¦OCR
```

**åŠ¹æœ**:
- UIå›ºã¾ã‚Šè§£æ¶ˆ
- åˆå›ä»¥é™ã®é«˜é€ŸåŒ–
- ç²¾åº¦ã¨é€Ÿåº¦ã®ä¸¡ç«‹

**å®Ÿè£…æ™‚é–“**: 4-6æ™‚é–“

---

#### 5. ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½å¼·åŒ– ğŸ“…
**æ´»ç”¨**: `avgKmPerMonth`ã‚’ä½¿ã£ãŸæœŸé™æ—¥æ¨å®š

```typescript
// è¡¨ç¤ºä¾‹
ã€Œã‚ã¨1,500kmï¼ˆæ¦‚ã­23æ—¥å¾Œï¼‰ã€

// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
remainingKm = nextMaintenanceKm - currentOdoKm
estimatedDays = Math.round(remainingKm / (avgKmPerMonth / 30))
```

**å®Ÿè£…æ™‚é–“**: 1-2æ™‚é–“

---

#### 6. ç”»åƒæœ€é©åŒ– ğŸ–¼ï¸
```typescript
// ç¾çŠ¶: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåœ§ç¸®ã®ã¿
// æ”¹å–„:
1. æœ€é•·è¾º1600pxã«åˆ¶é™
2. åŸæœ¬ã¨ç¸®å°ç‰ˆã‚’åˆ†ã‘ã¦ä¿å­˜
3. å°†æ¥: Cloud Functions ãƒˆãƒªã‚¬ã§è‡ªå‹•ç”Ÿæˆ

// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€ 
users/{uid}/cars/{carId}/
  â”œâ”€â”€ original/{timestamp}.jpg     // åŸæœ¬
  â””â”€â”€ thumbnails/{timestamp}.jpg   // ç¸®å°ç‰ˆ
```

**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

---

#### 7. Firestoreãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‹è¤‡åˆIndex ğŸ“Š
```typescript
// å¾¹åº•ã™ã¹ãç®‡æ‰€
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å±¥æ­´ä¸€è¦§ï¼ˆlimit + startAfterï¼‰
- çµ¦æ²¹ãƒ­ã‚°ä¸€è¦§
- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºä¸€è¦§

// è¤‡åˆIndexè¨­è¨ˆ
- carId + date desc
- carId + odoKm desc
- ownerUid + createdAt desc
- carId + deletedAt + createdAt desc  // è«–ç†å‰Šé™¤å¯¾å¿œ
```

**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

---

### ğŸŸ¢ Phase 3: ãƒãƒã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

#### 8. ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«UIæ”¹å–„ ğŸ’°
```typescript
// 2å°ç›®è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš— ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯1å°ã¾ã§      â”‚
â”‚                             â”‚
â”‚ ä»Šã¯2å°ç›®ã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã—ã¦ â”‚
â”‚ ã„ã¾ã™                       â”‚
â”‚                             â”‚
â”‚ ğŸ“‹ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã§è§£æ”¾ã•ã‚Œã‚‹    â”‚
â”‚   ãƒ»è¤‡æ•°å°ç™»éŒ²              â”‚
â”‚   ãƒ»PDFå±¥æ­´æ›¸               â”‚
â”‚   ãƒ»å±¥æ­´å…±æœ‰                â”‚
â”‚   ãƒ»åºƒå‘Šéè¡¨ç¤º              â”‚
â”‚   ãƒ»OCRç„¡åˆ¶é™ï¼ˆç„¡æ–™: 5å›/æœˆï¼‰â”‚
â”‚                             â”‚
â”‚ ğŸ’³ æœˆé¡480å††               â”‚
â”‚    å¹´æ‰•ã„4,800å††ï¼ˆ2ãƒ¶æœˆãŠå¾—ï¼‰â”‚
â”‚                             â”‚
â”‚ [ä»Šã™ãã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**OCRå›æ•°åˆ¶é™**:
- ç„¡æ–™: 5å›/æœˆ
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ : ç„¡åˆ¶é™

**å®Ÿè£…æ™‚é–“**: 3-4æ™‚é–“

---

#### 9. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç½²åãƒˆãƒ¼ã‚¯ãƒ³ ğŸ”
```typescript
// å…±æœ‰URLç”Ÿæˆæ™‚
interface ShareToken {
  carId: string;
  scope: 'view' | 'full';
  expiresAt: Timestamp;
  signature: string;  // HMAC-SHA256
}

// å°†æ¥ã®æ‹¡å¼µæ€§
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ: jsPDFï¼ˆç¾çŠ¶ç¶­æŒï¼‰
- ã‚µãƒ¼ãƒãƒ¼ç”Ÿæˆ: Cloud Functionsï¼ˆHTMLâ†’PDFï¼‰
  - å…¬å¼ã£ã½ã„è¦‹ãŸç›®
  - é€ã‹ã—ãƒ»QRã‚³ãƒ¼ãƒ‰
  - ç½²åãƒ»æ¤œè¨¼æ©Ÿèƒ½
```

**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

---

#### 10. ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å®Ÿè£… ğŸ“ˆ
**èª²é‡‘è»¢æ›ãƒ•ã‚¡ãƒãƒ«è¿½è·¡**

```typescript
// æœ€å°é™ã®ã‚¤ãƒ™ãƒ³ãƒˆ
const analyticsEvents = {
  // æ©Ÿèƒ½åˆ©ç”¨
  ocr_used: { type: 'fuel' | 'maintenance', success: boolean },
  fuel_created: { carId: string },
  maintenance_created: { carId: string },
  customization_created: { carId: string },
  pdf_exported: { carId: string },
  share_link_created: { carId: string },
  
  // èª²é‡‘ãƒ•ãƒ­ãƒ¼
  paywall_shown: { trigger: string, plan: string },
  paywall_click: { trigger: string, plan: string },
  subscribe_started: { plan: string },
  subscribe_success: { plan: string, amount: number },
};
```

**æ´»ç”¨**:
- æ©Ÿèƒ½åˆ¥åˆ©ç”¨ç‡åˆ†æ
- èª²é‡‘è»¢æ›ç‡ã®è¨ˆæ¸¬
- ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«æœ€é©åŒ–

**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

---

### ğŸ”µ Phase 4: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ‹¡å¼µï¼ˆå„ªå…ˆåº¦: ä½ï¼‰

#### 11. MaintenanceRecordæ‹¡å¼µ
```typescript
interface MaintenanceRecord {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
  
  // è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  items?: MaintenanceItem[];      // æ˜ç´°è¡Œ
  attachments?: Attachment[];     // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
}

interface MaintenanceItem {
  type: 'part' | 'labor' | 'other';
  name: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
}

interface Attachment {
  type: 'photo' | 'pdf' | 'receipt';
  url: string;
  fileName: string;
  uploadedAt: Timestamp;
}
```

**å®Ÿè£…æ™‚é–“**: 3-4æ™‚é–“

---

#### 12. FuelLogæ‹¡å¼µ
```typescript
interface FuelLog {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
  
  // è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  fuelType: 'regular' | 'premium' | 'diesel' | 'ev';  // ç‡ƒæ–™ç¨®åˆ¥
  stationName?: string;     // ã‚¹ã‚¿ãƒ³ãƒ‰å
  unit: 'JPY/L';           // å˜ä½ï¼ˆå°†æ¥ã®å¤–è²¨å¯¾å¿œï¼‰
}
```

**å®Ÿè£…æ™‚é–“**: 1-2æ™‚é–“

---

## å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ¨å¥¨ï¼‰

### Week 1: åŸºç›¤å¼·åŒ–
- [ ] Day 1-2: ãƒ‡ãƒ¼ã‚¿å‹çµ±ä¸€ï¼ˆinspectionExpiryï¼‰
- [ ] Day 3-4: æ‰€æœ‰æ¨©ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- [ ] Day 5: ç›£æŸ»è¨¼è·¡ã®è¨­è¨ˆã¨åŸºç¤å®Ÿè£…

### Week 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- [ ] Day 1-3: OCR Web WorkeråŒ–
- [ ] Day 4: ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½å¼·åŒ–
- [ ] Day 5: ç”»åƒæœ€é©åŒ–

### Week 3: ãƒãƒã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] Day 1-2: ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«UI
- [ ] Day 3: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç½²åãƒˆãƒ¼ã‚¯ãƒ³
- [ ] Day 4-5: ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å®Ÿè£…

### Week 4: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ‹¡å¼µ
- [ ] Day 1-2: MaintenanceRecordæ‹¡å¼µ
- [ ] Day 3: FuelLogæ‹¡å¼µ
- [ ] Day 4-5: Firestoreãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‹Index

---

## ç·å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| Phase | å·¥æ•° | å„ªå…ˆåº¦ |
|-------|------|--------|
| Phase 1: åŸºç›¤ | 6-9æ™‚é–“ | ğŸ”´ é«˜ |
| Phase 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | 9-14æ™‚é–“ | ğŸŸ¡ ä¸­ |
| Phase 3: ãƒãƒã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ | 7-10æ™‚é–“ | ğŸŸ¢ ä¸­ |
| Phase 4: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« | 4-6æ™‚é–“ | ğŸ”µ ä½ |
| **åˆè¨ˆ** | **26-39æ™‚é–“** | - |

---

## å³æ™‚å¯¾å¿œï¼ˆä»Šã‹ã‚‰é–‹å§‹ï¼‰

### 1. inspectionExpiryå‹çµ±ä¸€
```bash
git checkout -b fix/unify-inspection-expiry-type
```

1. å‹å®šç¾©ã®æ›´æ–°
2. ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
3. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
4. ãƒ†ã‚¹ãƒˆ

**é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ**

---

*ä½œæˆæ—¥: 2025-11-01*  
*æœ€çµ‚æ›´æ–°: 2025-11-01*

