# 退会の導線設計

## 概要

GarageLogの退会導線を設計し、ユーザーが適切にアカウントを削除またはサブスクリプションを解約できるよう最適化します。

## 現在の実装状況

### ✅ 実装済みの導線

1. **サブスクリプションのキャンセル**
   - `/settings/billing` ページからStripeカスタマーポータル経由で可能
   - プレミアムユーザー向けに「請求情報を管理」ボタンが表示
   - カスタマーポータルで以下の操作が可能:
     - 支払い方法の変更
     - 請求履歴の確認
     - 領収書のダウンロード
     - サブスクリプションのキャンセル

2. **アカウント削除の案内**
   - `/support` ページに「アカウントを削除したい」項目が存在
   - 現在はサポートへの問い合わせが必要

### ⚠️ 未実装/改善が必要な導線

1. **アカウント削除の直接実行機能**
   - 現在はサポート問い合わせのみ
   - ユーザーが自分で削除できる機能が必要

2. **設定ページの拡張**
   - `/settings/billing` のみ存在
   - アカウント管理セクションがない

3. **退会確認フロー**
   - データ削除の確認
   - 最終確認のモーダル

## 退会の種類と導線設計

### 1. サブスクリプションの解約（プレミアムユーザー）

**目的**: プレミアムプランを解約し、無料プランに戻る

**現在の導線**:
- `/settings/billing` → 「請求情報を管理」ボタン → Stripeカスタマーポータル → キャンセル

**改善案**:
- ✅ 現在の導線で十分機能している
- カスタマーポータルで「次回更新日以降にキャンセル」が可能
- 即座のキャンセルも可能（Stripeの設定による）

**実装優先度**: 🟢 低（既に実装済み）

---

### 2. アカウント削除（完全退会）

**目的**: アカウントとすべてのデータを完全に削除

**現在の導線**:
- `/support` → 「アカウントを削除したい」→ サポート問い合わせ

**改善案**:
- `/settings/account` ページを新規作成
- アカウント削除ボタンを追加
- 確認モーダルで警告を表示
- データエクスポート機能（オプション）

**実装優先度**: 🔴 高

---

## ユーザージャーニーと導線設計

### フェーズ1: 退会の検討段階

**目的**: ユーザーが退会を検討している段階での情報提供

**導線**:
1. **設定ページへのアクセス**
   - ホームページのユーザーアイコン/メニューから「設定」へ
   - `/settings/account` ページを作成

2. **退会理由の確認**
   - 「退会を検討していますか？」セクション
   - よくある理由の選択肢:
     - 使わなくなった
     - 機能が足りない
     - 料金が高い
     - 別のサービスに移行
     - その他

**実装優先度**: 🟡 中

---

### フェーズ2: サブスクリプション解約（プレミアムユーザー）

**目的**: プレミアムプランを解約し、無料プランに戻る

**導線**:
1. **請求管理ページから解約**
   - `/settings/billing` → 「請求情報を管理」ボタン
   - Stripeカスタマーポータルで解約

2. **解約確認**
   - カスタマーポータルで解約を実行
   - 解約後、無料プランに自動的に戻る
   - 解約完了の通知を表示

**実装優先度**: 🟢 低（既に実装済み）

---

### フェーズ3: アカウント削除（完全退会）

**目的**: アカウントとすべてのデータを完全に削除

**導線**:
1. **アカウント設定ページ**
   - `/settings/account` ページを作成
   - 「アカウントを削除する」セクションを追加

2. **削除前の確認**
   - 削除ボタンをクリック
   - 確認モーダルを表示:
     - 削除されるデータの説明
     - 復元不可能であることの警告
     - データエクスポートの案内（オプション）

3. **最終確認**
   - 「削除」と入力して確認
   - 削除実行

4. **削除処理**
   - Firebase Authentication からユーザーを削除
   - Firestore のユーザーデータを削除
   - Firebase Storage のユーザーファイルを削除
   - Stripe の顧客情報を削除（該当する場合）

**実装優先度**: 🔴 高

---

## UI/UX設計

### 設定ページの構造

```
/settings/
  ├── /billing      (既存: 請求管理)
  └── /account      (新規: アカウント管理)
```

### アカウント設定ページ (`/settings/account`)

**セクション構成**:

1. **アカウント情報**
   - メールアドレス表示
   - 登録日表示
   - プラン情報

2. **データ管理**
   - データエクスポート（オプション）
   - データ削除の説明

3. **アカウント削除**
   - 「アカウントを削除する」ボタン
   - 警告メッセージ

### アカウント削除確認モーダル

**表示内容**:
- タイトル: 「アカウントを削除しますか？」
- 警告メッセージ:
  - 削除されるデータの一覧
  - 復元不可能であること
  - サブスクリプションも解約されること（該当する場合）
- データエクスポートの案内（オプション）
- 確認入力欄: 「削除」と入力
- ボタン:
  - 「キャンセル」（閉じる）
  - 「アカウントを削除する」（赤色、危険な操作）

---

## データ削除の範囲

### 削除されるデータ

1. **Firebase Authentication**
   - ユーザーアカウント情報

2. **Firestore**
   - ユーザードキュメント (`users/{uid}`)
   - 車両データ (`users/{uid}/cars`)
   - メンテナンス記録 (`users/{uid}/maintenance`)
   - 給油記録 (`users/{uid}/fuelLogs`)
   - カスタム記録 (`users/{uid}/customs`)
   - その他のユーザーデータ

3. **Firebase Storage**
   - 車両画像 (`users/{uid}/cars/{carId}/images`)
   - その他のユーザーファイル

4. **Stripe**（該当する場合）
   - 顧客情報
   - サブスクリプション情報

### 保持されるデータ（法的要件）

- 請求履歴（税務上の要件）
- ログデータ（セキュリティ上の要件）
- 匿名化された分析データ

---

## メッセージング戦略

### 退会を防ぐメッセージ

1. **解約前のリテンション**
   - 「本当に解約しますか？」確認
   - 解約理由の選択肢を提供
   - フィードバックを収集

2. **価値の再提示**
   - 「これまでの記録を失います」
   - 「プレミアム機能を利用できなくなります」

### 退会を尊重するメッセージ

1. **スムーズな退会体験**
   - 明確な手順
   - データエクスポートの案内
   - 再登録の案内

2. **感謝のメッセージ**
   - 「ご利用ありがとうございました」
   - 「またのご利用をお待ちしております」

---

## 実装タスク

### 優先度: 高 🔴

- [ ] **アカウント設定ページの作成**
  - `/settings/account` ページを作成
  - アカウント情報の表示
  - アカウント削除ボタンの追加

- [ ] **アカウント削除機能の実装**
  - 確認モーダルの実装
  - Firebase Authentication からの削除
  - Firestore データの削除
  - Firebase Storage ファイルの削除
  - Stripe 顧客情報の削除（該当する場合）

- [ ] **削除確認フローの実装**
  - 警告メッセージの表示
  - 確認入力欄の実装
  - 削除処理の実行

### 優先度: 中 🟡

- [ ] **データエクスポート機能**（オプション）
  - ユーザーデータのエクスポート
  - JSON形式でのダウンロード
  - PDF形式での履歴出力

- [ ] **退会理由の収集**
  - 解約理由の選択肢
  - フィードバックフォーム
  - 分析用のデータ収集

### 優先度: 低 🟢

- [ ] **設定ページのナビゲーション改善**
  - 設定ページのメニュー追加
  - ホームページからのアクセス改善

- [ ] **リテンション施策**
   - 解約前のオファー表示
   - 一時停止機能（将来実装）

---

## セキュリティとコンプライアンス

### セキュリティ対策

1. **認証確認**
   - 削除前に再認証を要求
   - セッションの確認

2. **削除の最終確認**
   - 「削除」と入力して確認
   - 二段階確認

3. **ログ記録**
   - 削除操作のログ記録
   - 監査証跡の保持

### コンプライアンス

1. **GDPR対応**
   - データ削除権の実装
   - データエクスポート機能（オプション）

2. **個人情報保護法対応**
   - データ削除の明確な手順
   - 削除範囲の明示

---

## エラーハンドリング

### 削除処理中のエラー

1. **部分的な削除失敗**
   - エラーログの記録
   - 管理者への通知
   - ユーザーへの通知

2. **再試行メカニズム**
   - 失敗した削除処理の再試行
   - バックグラウンドジョブでの処理

---

## 分析と最適化

### 追跡すべき指標

1. **退会率**
   - サブスクリプション解約率
   - アカウント削除率

2. **退会理由**
   - 解約理由の分布
   - フィードバックの分析

3. **リテンション**
   - 解約前の滞在期間
   - 再登録率

### 最適化のポイント

1. **退会理由の分析**
   - よくある理由の特定
   - 改善施策の検討

2. **リテンション施策**
   - 解約前のオファー
   - 一時停止機能の検討

---

## 参考資料

- [Firebase Authentication - ユーザー削除](https://firebase.google.com/docs/auth/admin/manage-users#delete_a_user)
- [Firestore - データ削除](https://firebase.google.com/docs/firestore/manage-data/delete-data)
- [Stripe - 顧客削除](https://stripe.com/docs/api/customers/delete)
- [GDPR - データ削除権](https://gdpr.eu/right-to-be-forgotten/)
- [請求管理ページ](../src/app/settings/billing/page.tsx)
- [サポートページ](../src/app/support/page.tsx)

