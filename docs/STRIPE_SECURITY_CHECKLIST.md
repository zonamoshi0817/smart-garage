# Stripe セキュリティチェックリスト実装状況

## 1. 管理者画面のアクセス制限と管理者の ID / PW 管理

### 1.1 管理者画面のアクセス制限
- **状況**: 該当なし
- **理由**: GarageLogには管理者画面が存在しません。Firebase Admin SDKはサーバーサイドAPIでのみ使用され、管理画面UIは実装されていません。

### 1.2 二段階認証または二要素認証
- **状況**: 手動設定が必要
- **実装**: 管理用アカウント（Stripe、Firebase、GitHub、Vercel）で2段階認証を有効化する必要があります。
- **参考**: `docs/SECURITY_POLICY.md` の「5.3 ログインID/パスワード管理」セクション

### 1.3 アカウントロック機能
- **状況**: Firebase Authenticationのデフォルト機能を使用
- **実装**: Firebase Authenticationは自動的にログイン試行回数を制限します（`auth/too-many-requests`エラー）。
- **確認**: `src/app/login/page.tsx` で `auth/too-many-requests` エラーをハンドリング

## 2. データディレクトリ露出による設定不備対策

### 2.1 公開ディレクトリへの重要なファイルの配置
- **状況**: ✅ 実装済み
- **実装**: Next.jsの`public`ディレクトリには画像ファイルのみを配置。重要なファイル（環境変数、設定ファイル等）は配置していません。

### 2.2 特定のディレクトリを非公開にする
- **状況**: ✅ 実装済み
- **実装**: Next.jsのデフォルト動作により、`src`ディレクトリ内のファイルは公開されません。

### 2.3 アップロード可能な拡張子やファイルの制限
- **状況**: ✅ 実装済み
- **実装**: `src/lib/storage.ts` で画像ファイルのみを許可
  - `isImageFile()` 関数で画像ファイルをチェック
  - `validateFileSize()` 関数でファイルサイズを制限（最大5MB）

## 3. Web アプリケーションの脆弱性対策

### 3.1 脆弱性診断またはペネトレーションテスト
- **状況**: 定期的な実施が必要
- **実装**: 月1回程度の依存ライブラリの脆弱性確認と更新を推奨

### 3.2 SQL インジェクション対策
- **状況**: ✅ 実装済み
- **理由**: Firestore（NoSQL）を使用しており、SQLインジェクションのリスクはありません。Firestoreのクエリは型安全で、パラメータ化されています。

### 3.3 クロスサイト・スクリプティング（XSS）対策
- **状況**: ✅ 実装済み
- **実装**: 
  - ReactのデフォルトでXSS対策が有効（自動エスケープ）
  - 入力値のバリデーションを実装（`src/app/login/page.tsx`, `src/app/signup/page.tsx`）
  - APIルートでの入力値検証（`src/app/api/stripe/create-checkout-session/route.ts`）

### 3.4 セキュアコーディング・ソースコードレビュー
- **状況**: ✅ 実装済み
- **実装**: 
  - 入力フォームの入力値チェックを実装
  - 型安全性を確保（TypeScript使用）
  - Firebase Security Rulesでサーバーサイドのバリデーションを実装

## 4. マルウェア対策としてのウイルス対策ソフトの導入、運用

- **状況**: 開発環境での対応
- **実装**: 個人開発レベルでは、開発マシンでのウイルス対策ソフトの導入を推奨

## 5. 悪質な有効性確認、クレジットマスターへの対策

### 5.1 不審な IP アドレスからのアクセス制限
- **状況**: Vercelの機能を使用可能
- **実装**: VercelのIP制限機能を使用して、不審なIPアドレスからのアクセスを制限できます。

### 5.2 同一アカウントからの入力制限
- **状況**: ✅ 実装済み
- **実装**: Firebase Authenticationが自動的にログイン試行回数を制限します。

### 5.3 エラー内容の非表示
- **状況**: ✅ 実装済み
- **実装**: 
  - APIルートで詳細なエラーメッセージを非表示にし、一般的なメッセージのみ返す
  - `src/app/api/stripe/create-checkout-session/route.ts`
  - `src/app/api/account/delete/route.ts`
  - `src/app/api/account/downgrade/route.ts`

### 5.4 EMV 3-D セキュア
- **状況**: ✅ 実装済み
- **実装**: `src/lib/stripe.ts` で `payment_method_options.card.request_three_d_secure: 'automatic'` を設定

### 5.5 有効性確認の回数制限
- **状況**: ✅ Stripeが自動的に制限
- **実装**: Stripeは、さまざまな要素とデータに従って、カードの有効性の確認可能回数を自動的に制限します。

## 6. 不正ログイン対策

### 6.1 会員登録時

#### 6.1.1 不審な IP アドレスからのアクセス制限
- **状況**: Vercelの機能を使用可能
- **実装**: VercelのIP制限機能を使用して、不審なIPアドレスからのアクセスを制限できます。

#### 6.1.2 二要素認証
- **状況**: 未実装（将来の拡張として検討）
- **実装**: Firebase Authenticationで2要素認証を有効化できます。

#### 6.1.3 会員登録時の個人情報確認
- **状況**: ✅ 実装済み
- **実装**: 
  - メールアドレスの形式チェック（`src/app/signup/page.tsx`）
  - パスワードの強度チェック（最小6文字）
  - Firebase Authenticationによるメールアドレス確認（オプション）

#### 6.1.4 不正検知システム（Fraud サービス）
- **状況**: Stripe Radarを使用
- **実装**: Stripe Radarの標準ルールを有効化（Stripeダッシュボードで設定）

### 6.2 ログイン認証時

#### 6.2.1 不審な IP アドレスからのアクセス制限
- **状況**: Vercelの機能を使用可能
- **実装**: VercelのIP制限機能を使用して、不審なIPアドレスからのアクセスを制限できます。

#### 6.2.2 二要素認証
- **状況**: 未実装（将来の拡張として検討）
- **実装**: Firebase Authenticationで2要素認証を有効化できます。

#### 6.2.3 ログイン試行回数の制限強化
- **状況**: ✅ 実装済み
- **実装**: Firebase Authenticationが自動的にログイン試行回数を制限します（`auth/too-many-requests`エラー）。
- **確認**: `src/app/login/page.tsx` で `auth/too-many-requests` エラーをハンドリング

#### 6.2.4 ログイン時のメールや SMS 通知、スロットリング等
- **状況**: 未実装（将来の拡張として検討）
- **実装**: Firebase Authenticationでログイン通知を実装できます。

#### 6.2.5 指紋認証等
- **状況**: 未実装（将来の拡張として検討）
- **実装**: WebAuthn APIを使用して指紋認証を実装できます。

### 6.3 属性変更時

#### 6.3.1 不審な IP アドレスからのアクセス制限
- **状況**: Vercelの機能を使用可能
- **実装**: VercelのIP制限機能を使用して、不審なIPアドレスからのアクセスを制限できます。

#### 6.3.2 二要素認証
- **状況**: 未実装（将来の拡張として検討）
- **実装**: Firebase Authenticationで2要素認証を有効化できます。

#### 6.3.3 不正検知システム（Fraud サービス）
- **状況**: Stripe Radarを使用
- **実装**: Stripe Radarの標準ルールを有効化（Stripeダッシュボードで設定）

#### 6.3.4 指紋認証等
- **状況**: 未実装（将来の拡張として検討）
- **実装**: WebAuthn APIを使用して指紋認証を実装できます。

## 実装済みの項目まとめ

✅ **実装済み**:
- カード情報の非保持化（Stripe Checkout使用）
- 3Dセキュアの有効化
- エラー内容の非表示
- 入力値のバリデーション（XSS対策）
- Firebase Security Rulesによる認証・認可制御
- ログイン試行回数の制限（Firebase Authentication）
- ファイルアップロードの制限
- 公開ディレクトリへの重要なファイルの非配置

⚠️ **手動設定が必要**:
- Stripe Radarの有効化（Stripeダッシュボードで設定）
- 管理用アカウントの2段階認証（Stripe、Firebase、GitHub、Vercel）
- VercelのIP制限機能（必要に応じて設定）

🔮 **将来の拡張として検討**:
- 二要素認証（2FA）
- ログイン通知（メール/SMS）
- 指紋認証（WebAuthn）

---

**最終更新日**: 2024年12月

