# メンテナンス提案機能 実装ドキュメント

## 📋 概要

**garage log** の「次回メンテナンス提案」機能は、走行距離と経過時間の2軸でメンテナンス時期を判定し、ユーザーに最適なタイミングで整備を提案します。

## 🎯 主要機能

### 1. 2軸判定システム

#### 距離ベース判定
- 前回メンテからの走行距離で期限を計算
- 例：オイル交換は5,000kmごと

#### 時間ベース判定
- 前回メンテからの経過時間で期限を計算
- 例：ブレーキフルードは24ヶ月ごと

#### 統合判定
**早い方の期限を採用**して提案
- 距離: 残り1,000km（約1ヶ月後）
- 時間: 残り15日
→ **15日後**を期限として採用

### 2. データ完全性による判定モード切替

システムは利用可能なデータに応じて、自動的に最適な判定モードを選択します。

| モード | データ状況 | 精度 | 動作 |
|--------|----------|------|------|
| **High（★★★）** | 履歴 + ODO | 高 | 距離ベース優先 |
| **Medium（★★☆）** | 履歴のみ | 中 | 時間ベースのみ |
| **Low（★☆☆）** | 履歴なし | 低 | 車の登録日から推定 |

**履歴ゼロでも提案可能**：車の年式や登録日を基準に時間ベースで提案します。

### 3. 優先度スコアとステータスバッジ

#### 緊急度スコア（0-100）

```typescript
kmRatio    = clamp(1 - remainKm / cycle.km, 0, 1)
timeRatio  = clamp(1 - remainDays / (cycle.months*30), 0, 1)
progress   = max(kmRatio, timeRatio)  // 早い方に寄せる
overPenalty= isOverdue ? 0.25 : 0     // 期限超過ボーナス
score      = round((progress + overPenalty) * 100)
```

#### ステータスバッジ

| バッジ | 条件 | 説明 |
|--------|------|------|
| 🔴 **緊急** | 期限超過 or 残り≤500km/30日 | 早急な対応が必要 |
| 🟠 **まもなく** | スコア≥85% | 近日中に実施推奨 |
| 🟡 **近日** | スコア≥70% | 計画的に準備 |
| 🟢 **余裕あり** | スコア<70% | まだ時間あり |

### 4. ベースラインメンテナンススケジュール

| 項目 | 距離 | 時間 | アイコン |
|------|------|------|---------|
| エンジンオイル交換 | 5,000km | 6ヶ月 | 🛢️ |
| オイルフィルター交換 | 10,000km | 12ヶ月 | 🔧 |
| タイヤローテーション | 10,000km | 12ヶ月 | 🔄 |
| ブレーキフルード交換 | - | 24ヶ月 | 🛑 |
| エアフィルター交換 | 30,000km | 24ヶ月 | 💨 |
| ワイパーゴム交換 | - | 12ヶ月 | 🌧️ |

## 📁 ファイル構成

### 新規作成ファイル

```
src/
├── lib/
│   └── maintenanceSuggestions.ts    # コアロジック（430行）
│       ├── MAINTENANCE_ITEMS        # メンテ項目定義
│       ├── calculateNextDue()       # 期限計算
│       ├── calculateUrgencyScore()  # スコア算出
│       ├── determineStatus()        # ステータス判定
│       └── generateMaintenanceSuggestions() # メイン関数
│
└── components/mycar/
    └── NextMaintenanceSuggestion.tsx # UIコンポーネント（270行）
        ├── SuggestionCard           # 提案カード
        ├── getStatusBadge()         # バッジ情報取得
        └── getConfidenceBadge()     # 信頼度表示
```

## 🔧 実装の特徴

### 1. フォールバック設計

データがなくても**常に提案を表示**できる設計：

```typescript
// 履歴なし → 車の登録日から起算
const fallbackStartDate = getCarStartDate(car);

// ODOなし → 時間ベースのみで判定
if (!currentOdo) {
  // 時間ベースの計算のみ実行
}
```

### 2. 平均走行距離の活用

`car.avgKmPerMonth`を使用して、距離を日数に換算：

```typescript
// 残り1,000km、平均50km/月 → 約20日
const kmToDays = (remainKm / avgKmPerMonth) * 30;
```

### 3. エッジケース対応

#### ODO未登録
- 時間ベースのみで判定
- 警告メッセージを表示
- 信頼度は★★☆以下

#### 走行ゼロ/極端に少ない
- `avgKmPerMonth <= 0` は距離判定をスキップ
- 時間のみで判定

#### 初回直後（履歴が同日/同距離）
- 残り = フルサイクル
- スコアが低く、提案に出にくい

#### ロールバック疑い
- `currentOdo < lastOdo` の場合は無効扱い
- 給油・メンテ登録時の整合性チェックは既存仕様に準拠

## 🎨 UI表示仕様

### カード構成

```
┌─────────────────────────────────────────────────┐
│ 🛢️    🔴 緊急                                   │
│ オイル  ★★★                                     │
│                                                 │
│ エンジンオイル交換                                │
│ あと約200km / 5日 （推定：ODO未登録）             │
│ ⚠️ 期限超過：早めの実施を推奨します                │
│                                                 │
│ 進捗 ████████████████░░░░ 85%                   │
│ 🚗 残り 200 km  📅 残り 5 日                    │
│ ※部品・費用は車種により異なります                  │
│                                                 │
│                         [📝 テンプレから作成]    │
└─────────────────────────────────────────────────┘
```

### 表示項目

1. **アイコン＋ステータスバッジ** - 視覚的な緊急度
2. **タイトル＋信頼度** - 項目名と精度表示
3. **メッセージ** - わかりやすい説明
4. **期限超過警告** - 該当する場合のみ
5. **進捗バー** - スコアの視覚化
6. **詳細情報** - 距離と時間の内訳
7. **注記** - 車種依存の注意書き
8. **アクションボタン** - テンプレート作成

### 警告バナー

#### ODO未登録
```
⚠️ 走行距離（ODO）未登録：時間ベースで提案しています。
   ODOを登録すると、より正確なメンテナンス提案ができます。
```

#### 平均走行距離未登録
```
💡 平均走行距離未登録：車両設定で月間走行距離を登録すると、
   残り日数の推定精度が向上します。
```

## 🚀 使用方法

### コンポーネントの使用

```tsx
import NextMaintenanceSuggestion from '@/components/mycar/NextMaintenanceSuggestion';

<NextMaintenanceSuggestion
  car={car}
  maintenanceRecords={maintenanceRecords}
  onCreateFromTemplate={(templateId) => {
    // テンプレートからメンテナンスを作成
    console.log('Create from template:', templateId);
  }}
/>
```

### ロジックの直接使用

```typescript
import { generateMaintenanceSuggestions } from '@/lib/maintenanceSuggestions';

const suggestions = generateMaintenanceSuggestions(car, maintenanceRecords);

// スコアでソート済み
suggestions.forEach(s => {
  console.log(`${s.title}: ${s.score}% (${s.status})`);
});
```

## 📊 動作例

### ケース1: 履歴あり、ODOあり（高精度）

**データ**：
- 前回オイル交換: 45,000km、60日前
- 現在: 48,500km
- 平均: 50km/月

**計算**：
- 残り距離: 5,000 - 3,500 = **1,500km**
- 残り時間: 180日 - 60日 = **120日**
- 日数換算: 1,500km ÷ 50km/月 × 30 = **900日**
- 採用: min(120日, 900日) = **120日**

**結果**：
- スコア: 67%
- ステータス: 🟡 近日
- 信頼度: ★★★ 高精度

### ケース2: 履歴あり、ODOなし（中精度）

**データ**：
- 前回ワイパー交換: 330日前
- ODO: 未登録

**計算**：
- 残り時間: 365日 - 330日 = **35日**
- 距離: データなし

**結果**：
- スコア: 90%
- ステータス: 🟠 まもなく
- 信頼度: ★★☆ 中精度

### ケース3: 履歴なし（低精度）

**データ**：
- 履歴: なし
- 車の年式: 2020年（5年経過）
- ODO: 50,000km

**計算**：
- オイル: 50,000 ÷ 5,000 = 10サイクル完了
- 次回: 55,000km（残り5,000km）

**結果**：
- スコア: 0%
- ステータス: 🟢 余裕あり
- 信頼度: ★☆☆ 低精度

## 🔮 拡張性

### 走行環境別の係数

将来的に、走行環境に応じてサイクルを調整可能：

```typescript
// 例：シビアコンディション対応
const HEAVY_DUTY_FACTOR = 0.8;

if (car.environment === 'severe') {
  cycle.km = cycle.km * HEAVY_DUTY_FACTOR;
}
```

### カスタムサイクル

ユーザーが独自のメンテナンスサイクルを設定：

```typescript
const userCustomCycles = {
  oil: { km: 3000, months: 3 }  // より頻繁なオイル交換
};
```

## ✅ テスト項目

### 基本動作
- [ ] 履歴あり+ODOありで正確に計算される
- [ ] 履歴のみで時間ベース計算される
- [ ] 履歴なしで車の登録日から推定される
- [ ] スコアが正しく計算される
- [ ] ステータスバッジが正しく表示される

### エッジケース
- [ ] ODOが0の場合
- [ ] 平均走行距離が0の場合
- [ ] 期限超過の場合
- [ ] 走行距離がマイナスの場合（ロールバック）
- [ ] データが全くない場合

### UI
- [ ] 6項目すべて表示される
- [ ] 警告バナーが適切に表示される
- [ ] テンプレート作成ボタンが動作する
- [ ] 進捗バーが正しく表示される
- [ ] 信頼度ツールチップが機能する

## 📝 まとめ

この実装により、**garage log** は：

✅ **データがなくても使える** - 履歴ゼロでも時間ベースで提案  
✅ **精度が自然に向上** - 履歴・ODOが揃うほど正確に  
✅ **透明性が高い** - 信頼度を明示、ユーザーが判断しやすい  
✅ **拡張可能** - 走行環境やカスタムサイクルに対応可能  

---

**作成日**: 2025年11月10日  
**バージョン**: 1.0  
**実装ファイル**: 
- `src/lib/maintenanceSuggestions.ts`
- `src/components/mycar/NextMaintenanceSuggestion.tsx`

