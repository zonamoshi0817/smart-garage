# Sell Boost機能 E2Eテスト手順

## 前提条件
- ローカルサーバーが起動している（`npm run dev`）
- ログイン済み
- テスト用の車両が登録済み
- テスト用のメンテナンス記録がいくつか登録済み（未分類レコードも含む）

---

## テスト1: 売却モードON → ウィザードで分類 → 公開ページOK

### ステップ1: 売却モードページにアクセス

1. ブラウザで以下のURLにアクセス（`[vehicleId]`は実際の車両IDに置き換え）:
   ```
   http://localhost:3000/vehicles/[vehicleId]/sale-mode
   ```

   **vehicleIdの確認方法:**
   - ホームページ (`/home`) で車両を選択
   - ブラウザの開発者ツール（F12）でコンソールを開き、`console.log` で確認
   - または、Firebase Consoleで `users/{uid}/cars` コレクションを確認

### ステップ2: 売却モードをONにする

1. 「売却モードをON」ボタンをクリック
2. 未分類のメンテナンス記録がある場合、自動的に分類ウィザードが表示される

### ステップ3: 分類ウィザードを実行

1. ウィザードが表示されたら、各レコードに対して以下を設定:
   - **カテゴリ（必須）**: ドロップダウンから選択（oil, tire, brake, battery, coolant, etc.）
   - **予防整備**: チェックボックスで選択
   - **タイプ**: `receipt_backed`（証跡あり）または `owner_log`（所有者記録）

2. 「次へ」ボタンで次のレコードに進む
3. すべてのレコードを分類したら「完了」ボタンをクリック

### ステップ4: 公開ページを確認

1. 売却モードページに「公開URL: `/s/[slug]`」が表示される
2. そのURLをクリック（または新しいタブで開く）
3. 以下の内容が表示されることを確認:
   - ✅ 査定の要点セクション（直近整備・消耗品交換・証跡点数）
   - ✅ 車両サマリー
   - ✅ 直近12ヶ月サマリー（分類したレコードが表示される）
   - ✅ 未分類レコードの説明（未分類がある場合）
   - ✅ 消耗品交換一覧
   - ✅ 予防整備一覧
   - ✅ 証跡（まだアップロードしていない場合は空）

---

## テスト2: 証跡アップロード → マスク → 公開ページ表示OK

### ステップ1: 証跡をアップロード

1. 売却モードページで「証跡をアップロード」ボタンをクリック
   - または、直接 `/vehicles/[vehicleId]/evidence/upload` にアクセス

2. ファイル選択ボタンで画像ファイルを選択（JPEG、PNG、WebP、HEIC対応）

### ステップ2: マスク編集

1. 画像がアップロードされると、自動的にマスク編集画面に遷移
2. 画像上でマウスをドラッグして矩形を描画（個人情報を隠す部分）
3. 複数の矩形を描画可能
4. 「マスクを適用」ボタンをクリック
5. 「アップロード完了」のメッセージが表示される

### ステップ3: 公開ページで証跡を確認

1. 公開ページ（`/s/[slug]`）に戻る
2. ページをリロード
3. 「証跡」セクションにマスク済み画像が表示されることを確認:
   - ✅ サムネイルが表示される
   - ✅ クリックするとモーダルで拡大表示される
   - ✅ マスクが正しく適用されている

---

## テスト3: PDF（査定/譲渡）内容確認（未分類注記含む）

### ステップ1: 査定用PDFをダウンロード

1. 公開ページ（`/s/[slug]`）で「査定用PDF」ボタンをクリック
2. PDFがダウンロードされる
3. PDFを開いて以下を確認:
   - ✅ タイトル「査定用 車両情報」
   - ✅ **未分類レコードがある場合、タイトル直下に「※未分類のメンテナンス記録X件は除外しています」の注記が表示される**
   - ✅ 車両概要
   - ✅ 売りポイント（3つ）
   - ✅ 直近12ヶ月サマリー（分類済みレコードのみ）
   - ✅ 消耗品交換一覧
   - ✅ 証跡数（証跡がある場合）
   - ✅ 最終ページに未分類注記（未分類がある場合）

### ステップ2: 譲渡用PDFをダウンロード

1. 公開ページで「譲渡用PDF」ボタンをクリック
2. PDFがダウンロードされる
3. PDFを開いて以下を確認:
   - ✅ タイトル「譲渡用 車両情報」
   - ✅ **未分類レコードがある場合、タイトル直下に「※未分類のメンテナンス記録X件は除外しています」の注記が表示される**
   - ✅ 車両概要
   - ✅ 次回推奨メンテナンス
   - ✅ 重要整備履歴
   - ✅ 消耗品交換一覧+推奨時期
   - ✅ 最終ページに未分類注記（未分類がある場合）

---

## テスト4: visibility=disabled → 公開ページ404＆画像アクセス403

### ステップ1: visibilityをdisabledに変更

1. 売却モードページ（`/vehicles/[vehicleId]/sale-mode`）に戻る
2. 「公開設定」セクションで「disabled（非公開）」ボタンをクリック
3. 確認ダイアログで「OK」をクリック

### ステップ2: 公開ページが404になることを確認

1. 公開ページ（`/s/[slug]`）にアクセス
2. **404 Not Found が表示されることを確認** ✅

### ステップ3: 画像アクセスが403になることを確認

1. ブラウザの開発者ツール（F12）を開く
2. ネットワークタブを開く
3. 公開ページにアクセス（404が表示される）
4. 証跡画像へのリクエストが **403 Forbidden** で失敗することを確認 ✅
   - Storage Rulesにより、`visibility='disabled'` の場合、画像の読み取りが拒否される

### ステップ4: visibilityを元に戻す（テスト継続のため）

1. 売却モードページで「unlisted（noindex）」または「public（公開）」に戻す

---

## テスト5: 別ユーザーで salePageViews 読めない（403）

### ステップ1: テスト用の別ユーザーを作成

1. アプリからログアウト
2. 新しいアカウントでログイン（またはテスト用の別アカウントを作成）

### ステップ2: Firestore Rulesで読み取りが拒否されることを確認

**方法A: Firebase Consoleから確認**

1. Firebase Console（https://console.firebase.google.com）にアクセス
2. プロジェクトを選択
3. Firestore Database → データ タブ
4. `salePageViews` コレクションを開く
5. 任意のドキュメントをクリックして詳細を表示
6. **注意**: Consoleでは読み取れるが、これは管理者権限のため。実際のアプリからは読み取れない

**方法B: アプリ内から確認（推奨）**

1. ブラウザの開発者ツール（F12）を開く
2. コンソールタブを開く
3. 以下のコードを実行して、salePageViewsにアクセスを試みる:

```javascript
// 注意: これは別ユーザーでログインした状態で実行
const db = firebase.firestore();
const salePageViewsRef = db.collection('salePageViews');
salePageViewsRef.get().then((snapshot) => {
  console.log('Success:', snapshot.docs.length);
}).catch((error) => {
  console.error('Error:', error.code, error.message);
  // 期待される結果: "permission-denied"
});
```

4. **`permission-denied` エラーが表示されることを確認** ✅

**方法C: サーバーサイドで確認**

1. テスト用のAPIエンドポイントを作成するか、既存のAPIから確認
2. 別ユーザーでログインした状態で、salePageViewsを取得しようとする
3. **403エラーが返されることを確認** ✅

---

## 追加テスト項目（オプション）

### テスト6: コピペテンプレート機能

1. 公開ページ（`/s/[slug]`）で「査定依頼用メッセージをコピー」セクションを確認
2. 3種類のテンプレートが選択できることを確認:
   - SMS用（超短文）
   - メール用（丁寧）
   - 電話用（口頭スクリプト）
3. 各テンプレートを選択して「テンプレートをコピー」ボタンをクリック
4. クリップボードにコピーされることを確認 ✅

### テスト7: メモリリーク対策確認

1. 公開ページで証跡を表示
2. ブラウザの開発者ツール → Memory タブを開く
3. ページをリロードして、メモリ使用量が異常に増加しないことを確認 ✅
4. ObjectURLが適切にrevokeされていることを確認

### テスト8: 未分類レコードの説明表示

1. 未分類のメンテナンス記録がある車両で公開ページを開く
2. 「直近12ヶ月サマリー」セクションの上に黄色の警告ボックスが表示されることを確認:
   - ✅ 「未分類のメンテナンス記録がX件あります（売却資料には含めていません）」
3. PDFにも未分類注記が表示されることを確認（テスト3で確認済み）

---

## トラブルシューティング

### 公開ページが404になる

- 売却モードがONになっているか確認
- `vehicle.activeSaleProfileId` が正しく設定されているか確認（Firebase Console）
- `saleProfile.visibility` が `disabled` になっていないか確認

### 証跡が表示されない

- 証跡が `maskStatus='masked'` になっているか確認（Firebase Console）
- `saleProfile.includeEvidence` が `true` になっているか確認
- Storage Rulesで `public/sales/{saleProfileId}/` への読み取りが許可されているか確認

### PDFがダウンロードできない

- サーバーログを確認（エラーがないか）
- ブラウザの開発者ツール → ネットワークタブでエラーを確認
- `slug` が正しいか確認

### 分類ウィザードが表示されない

- 直近12ヶ月のメンテナンス記録があるか確認
- `category` フィールドが空のレコードがあるか確認（Firebase Console）

---

## 確認チェックリスト

- [ ] テスト1: 売却モードON → ウィザード → 公開ページOK
- [ ] テスト2: 証跡アップロード → マスク → 公開ページ表示OK
- [ ] テスト3: PDF（査定/譲渡）内容確認（未分類注記含む）
- [ ] テスト4: visibility=disabled → 公開ページ404＆画像アクセス403
- [ ] テスト5: 別ユーザーで salePageViews 読めない（403）
- [ ] テスト6: コピペテンプレート機能
- [ ] テスト7: メモリリーク対策確認（オプション）
- [ ] テスト8: 未分類レコードの説明表示
